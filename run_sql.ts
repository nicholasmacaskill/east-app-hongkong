const getDbPool = require('./app/lib/db.ts').default;
import { Pool } from 'pg';

// YOUR REAL SUPABASE USER ID
const TEST_USER_ID = 'a0eebc99-9c0b-4ef8-bb6d-6bb9bd380a11'; 

const schemaCommands = [
    // 1. Reset Tables
    "DROP TABLE IF EXISTS registrations CASCADE;",
    "DROP TABLE IF EXISTS players_stats CASCADE;",
    "DROP TABLE IF EXISTS sessions CASCADE;",
    "DROP TABLE IF EXISTS profiles CASCADE;",
    "DROP TABLE IF EXISTS posts CASCADE;",
    "DROP TABLE IF EXISTS likes CASCADE;",
    "DROP TABLE IF EXISTS messages CASCADE;",

    // 2. Create Tables (UUID Compatible)
    // ✅ ADDED: first_name, last_name, mobile, contact_email columns
    `CREATE TABLE profiles (
        id UUID REFERENCES auth.users(id) PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        last_name TEXT,
        mobile TEXT,
        contact_email TEXT,
        avatar_url TEXT,
        bio TEXT
    );`,
    
    `CREATE TABLE sessions (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
        title TEXT NOT NULL, 
        category TEXT, 
        instructor TEXT, 
        start_time TIMESTAMP WITH TIME ZONE NOT NULL, 
        end_time TIMESTAMP WITH TIME ZONE NOT NULL, 
        image_url TEXT, 
        description TEXT
    );`,

    `CREATE TABLE registrations (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, 
        user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL, 
        session_id BIGINT REFERENCES sessions(id) ON DELETE CASCADE NOT NULL, 
        registered_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()), 
        UNIQUE(user_id, session_id)
    );`,

    `CREATE TABLE players_stats (
        id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        player_id UUID REFERENCES auth.users(id) ON DELETE CASCADE, 
        age INTEGER, season INTEGER, team TEXT,
        games_played_season INTEGER, games_played_total INTEGER,
        games_missed_healthy INTEGER, games_missed_injured INTEGER,
        goals_season INTEGER, goals_total INTEGER,
        assists_season INTEGER, assists_total INTEGER,
        gp INTEGER, points INTEGER, gwg INTEGER, ppg INTEGER, shg INTEGER, pim INTEGER,
        top_scorer_team BOOLEAN, top_scorer_league BOOLEAN, least_pim_team BOOLEAN, most_shots_team BOOLEAN,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );`,

    `CREATE TABLE posts (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, user_id UUID REFERENCES profiles(id), image_url TEXT, caption TEXT, created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()), shared_post_id BIGINT REFERENCES posts(id));`,
    `CREATE TABLE likes (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, user_id UUID REFERENCES profiles(id), post_id BIGINT REFERENCES posts(id), UNIQUE(user_id, post_id));`,
    `CREATE TABLE messages (id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, sender_id UUID, receiver_id UUID, content TEXT, image_url TEXT, created_at TIMESTAMP WITH TIME ZONE DEFAULT timezone('utc'::text, now()), shared_event_id BIGINT);`,

    // 3. DISABLE RLS (Open Access)
    `ALTER TABLE registrations DISABLE ROW LEVEL SECURITY;`,
    `ALTER TABLE profiles DISABLE ROW LEVEL SECURITY;`,
    `ALTER TABLE posts DISABLE ROW LEVEL SECURITY;`,
    `ALTER TABLE sessions DISABLE ROW LEVEL SECURITY;`,
    `ALTER TABLE players_stats DISABLE ROW LEVEL SECURITY;`,
    `ALTER TABLE messages DISABLE ROW LEVEL SECURITY;`,

    // 4. STORAGE SETUP
    `INSERT INTO storage.buckets (id, name, public) VALUES ('uploads', 'uploads', true) ON CONFLICT (id) DO NOTHING;`,
    `DROP POLICY IF EXISTS "Public Access" ON storage.objects;`,
    `CREATE POLICY "Public Access" ON storage.objects FOR ALL USING ( bucket_id = 'uploads' ) WITH CHECK ( bucket_id = 'uploads' );`,

    // 5. Seed Data
    // ✅ ADDED: Seed new columns
    `INSERT INTO profiles (id, username, first_name, last_name, mobile, contact_email, bio, avatar_url) 
     VALUES ('${TEST_USER_ID}', 'lee.wong12', 'Lee', 'Wong', '+1 234 567 8900', 'lee@east.com', 'Defenseman for the Rhinos.', 'https://placehold.co/100') 
     ON CONFLICT (id) DO NOTHING;`,
    
    `INSERT INTO players_stats (player_id, age, season, team, games_played_season, goals_season, points)
     VALUES ('${TEST_USER_ID}', 31, 3, 'RHINOS', 48, 110, 6);`,

    `INSERT INTO sessions (title, category, instructor, start_time, end_time, description) 
     VALUES 
     ('Pro Hockey Drills', 'ADULT', 'Coach Alex', NOW() + interval '1 day', NOW() + interval '1 day 1 hour', 'High intensity.'),
     ('Youth Skating', 'YOUTH', 'Coach Sarah', NOW() + interval '2 days', NOW() + interval '2 days 1 hour', 'Fundamentals.');`,

    // Refresh Schema
    `NOTIFY pgrst, 'reload schema';`
];

async function runSql(pool: Pool, sqlQuery: string) {
    const client = await pool.connect();
    try { await client.query(sqlQuery); console.log(`✅ Executed: ${sqlQuery.substring(0, 50)}...`); } 
    catch (e) { console.error(`❌ Failed: ${sqlQuery.substring(0, 50)}...`, e); } 
    finally { client.release(); }
}

(async () => {
    const pool = getDbPool();
    for (const cmd of schemaCommands) await runSql(pool, cmd);
    await pool.end();
})();